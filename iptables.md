# Iptables setup

## Allow ssh
```
sudo iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -p tcp --sport 22 -m conntrack --ctstate ESTABLISHED -j ACCEPT
```

# Allow loopback connections (localhost)
```
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A OUTPUT -o lo -j ACCEPT
```

# Allow established tcp connections
```
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
```

## Allow outgoing udp
```
sudo iptables -A INPUT -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT
```
# Set policy to drop
```
sudo iptables -P INPUT DROP
```

# Open UDP input port for auth
```
sudo iptables -A INPUT -p udp -m udp --dport 13337 -j ACCEPT
```

## Persistent setup

Install 
```
apt install iptables-persistent
```

IPv4 and IPv6 rules can be saved to the following files during installation. These files will then be loaded into
iptables on system start up.

To add new rules to the startup save new rules to `/etc/iptables/rules.v4` and `/etc/iptables/rules.v6`

Either via `iptables-save > /etc/iptables/rules.v6` and `iptables-save > /etc/iptables/rules.v4`
or copy the following file (output of iptables-save):
```
# Generated by iptables-save v1.6.0 on Sun Feb  3 02:42:47 2019
*filter
:INPUT DROP [15:2068]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -p udp -m udp --dport 13337 -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p udp -m udp --sport 53 -m state --state ESTABLISHED -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
COMMIT
# Completed on Sun Feb  3 02:42:47 2019
```

### Restore setup (close all client connections)
```
iptables-restore </etc/iptables/rules.v4
iptables-restore </etc/iptables/rules.v6
```

Server IP: 3.121.215.119

on server clone git repo
cd inside
make sure pip3 is installed apt install python3-pip
make sure build-essential is installed apt install build-essential
(make sure python3-setuptools is installed apt install python3-setuptools)
install python package: python3 setup.py install
make sure nginx is installed and running on necessary ports for presentation

run cron job to reset iptables every 24h:
crontab -u root -e
    0 22 * * *      iptables-restore < /etc/iptables/rules.v4
    0 22 * * *      iptables-restore < /etc/iptables/rules.v6
thats it
(to make sure: service cron restart)
to see which cron jobs are running for you as a user: crontab -l    

to run:
cd to magicportknocker dir
setup server info and add first user: portknock-admin add
then copy /user_setup/0_username/save_file.json to portknocker dir on client computer
then start server portknock-server

on client to connect:
make sure you have the save_file.json from the user_setup dir on the server
run portknock-client